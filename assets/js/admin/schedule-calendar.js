webpackJsonp([7],{

/***/ 31:
/***/ (function(module, exports, __webpack_require__) {

module.exports = __webpack_require__(32);


/***/ }),

/***/ 32:
/***/ (function(module, exports) {

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; };

(function ($, moment) {
  'use strict';

  var DATE_FORMAT = 'YYYY-MM-DD';

  var Selection = Backbone.Model.extend({
    defaults: {
      unit: null,
      endDate: null,
      startDate: null
    },

    validate: function validate(attrs, options) {
      // ...
    },
    clearSelectedDate: function clearSelectedDate(newUnit) {
      this.set({ startDate: null, endDate: null });
      this.set('unit', newUnit);
    },
    getNights: function getNights() {
      if (!this.has('endDate') || !this.has('startDate')) {
        return 0;
      }

      return this.get('endDate').diff(this.get('startDate'), 'days');
    }
  });

  var ScheduleCalendar = Backbone.View.extend({
    options: {
      debug: true,
      marker: '.awebooking-schedule__marker'
    },

    events: {
      'click .awebooking-schedule__day': 'setSelectionDate',
      'mouseenter .awebooking-schedule__day': 'drawMarkerOnHover'
    },

    initialize: function initialize() {
      this.model = new Selection();

      this.$marker = this.$el.find(this.options.marker);
      this.$marker.hide();

      $(document).on('keyup', this.keyup.bind(this));
      // $(document).off('keyup', this.keyup);

      this.listenTo(this.model, 'change:startDate change:endDate', this.setMarkerPosition);
      if (this.options.debug) {
        this.listenTo(this.model, 'change', this.debug);
      }

      this.$el.data('schedule-calendar', this);
    },
    debug: function debug() {
      if (this.model.has('startDate') && this.model.has('endDate')) {
        console.log(this.model.get('unit'), this.model.get('startDate').format(DATE_FORMAT) + ' - ' + this.model.get('endDate').format(DATE_FORMAT));
      } else if (this.model.has('startDate')) {
        console.log(this.model.get('unit'), this.model.get('startDate').format(DATE_FORMAT) + ' - null');
      } else if (this.model.has('endDate')) {
        console.log(this.model.get('unit'), 'null' + ' - ' + this.model.get('endDate').format(DATE_FORMAT));
      }
    },
    keyup: function keyup(e) {
      if (e.keyCode == 27) {
        this.model.clearSelectedDate();
      }
    },
    setSelectionDate: function setSelectionDate(e) {
      var $target = $(e.currentTarget);
      var setUnit = this.getUnitByElement($target);
      var clickDate = moment($target.data('date'));

      if (this.model.has('unit') && setUnit !== this.model.get('unit') || this.model.has('startDate') && this.model.has('endDate') || this.model.has('startDate') && clickDate.isBefore(this.model.get('startDate'), 'day')) {
        this.model.clearSelectedDate(setUnit);
      }

      if (!this.model.has('startDate') && !this.model.has('endDate')) {
        this.model.set('unit', setUnit);
        this.model.set('startDate', clickDate.clone());
      } else {
        this.model.set('endDate', clickDate.clone());
        this.trigger('apply', this.model, this);
        console.log(this.model.getNights());
      }
    },
    setMarkerPosition: function setMarkerPosition() {
      var endDate = this.model.get('endDate');
      var startDate = this.model.get('startDate');

      if (_.isNull(startDate) && _.isNull(endDate)) {
        this.$marker.css('width', 60).hide();
        return;
      }

      var $startDateEl = this.getElementByDate(this.model.get('unit'), startDate);
      if (_.isNull(endDate)) {
        var position = $startDateEl.position();
        this.$marker.show().css({ top: position.top, left: position.left });
      } else {
        var $endDateEl = this.getElementByDate(this.model.get('unit'), endDate);
        this.$marker.css('width', ($endDateEl.index() - $startDateEl.index() + 1) * 60);
      }
    },
    drawMarkerOnHover: function drawMarkerOnHover(e) {
      var $target = $(e.currentTarget);
      var targetUnit = this.getUnitByElement($target);

      if (!this.model.has('unit') || this.model.get('unit') !== targetUnit || !this.model.has('startDate') || this.model.has('startDate') && this.model.has('endDate')) {
        return;
      }

      var hoverDate = moment($target.data('date'));
      var startDate = this.model.get('startDate');

      if (startDate.isSameOrBefore(hoverDate, 'day')) {
        var $startDateEl = this.getElementByDate(targetUnit, startDate);
        this.$marker.css('width', ($target.index() - $startDateEl.index() + 1) * 60);
      }
    },
    getElementByDate: function getElementByDate(unit, date) {
      if ((typeof date === 'undefined' ? 'undefined' : _typeof(date)) === 'object') {
        date = date.format(DATE_FORMAT);
      }

      return this.$el.find('[data-unit="' + unit + '"]').find('.awebooking-schedule__day[data-date="' + date + '"]');
    },
    getUnitByElement: function getUnitByElement(element) {
      var unit = $(element).data('unit');

      if (typeof unit === 'undefined') {
        unit = $(element).parent().data('unit');
      }

      unit = parseInt(unit, 10);
      return !isNaN(unit) ? unit : 0;
    }
  });

  new ScheduleCalendar({
    el: '.awebooking-schedule'
  });
})(jQuery, TheAweBooking.momment || window.moment);

/***/ })

},[31]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly8vLi9hc3NldHMvanNzcmMvYWRtaW4vY2FsZW5kYXIvc2NoZWR1bGUtY2FsZW5kYXIuanMiXSwibmFtZXMiOlsiJCIsIm1vbWVudCIsIkRBVEVfRk9STUFUIiwiU2VsZWN0aW9uIiwiQmFja2JvbmUiLCJNb2RlbCIsImV4dGVuZCIsImRlZmF1bHRzIiwidW5pdCIsImVuZERhdGUiLCJzdGFydERhdGUiLCJ2YWxpZGF0ZSIsImF0dHJzIiwib3B0aW9ucyIsImNsZWFyU2VsZWN0ZWREYXRlIiwibmV3VW5pdCIsInNldCIsImdldE5pZ2h0cyIsImhhcyIsImdldCIsImRpZmYiLCJTY2hlZHVsZUNhbGVuZGFyIiwiVmlldyIsImRlYnVnIiwibWFya2VyIiwiZXZlbnRzIiwiaW5pdGlhbGl6ZSIsIm1vZGVsIiwiJG1hcmtlciIsIiRlbCIsImZpbmQiLCJoaWRlIiwiZG9jdW1lbnQiLCJvbiIsImtleXVwIiwiYmluZCIsImxpc3RlblRvIiwic2V0TWFya2VyUG9zaXRpb24iLCJkYXRhIiwiY29uc29sZSIsImxvZyIsImZvcm1hdCIsImUiLCJrZXlDb2RlIiwic2V0U2VsZWN0aW9uRGF0ZSIsIiR0YXJnZXQiLCJjdXJyZW50VGFyZ2V0Iiwic2V0VW5pdCIsImdldFVuaXRCeUVsZW1lbnQiLCJjbGlja0RhdGUiLCJpc0JlZm9yZSIsImNsb25lIiwidHJpZ2dlciIsIl8iLCJpc051bGwiLCJjc3MiLCIkc3RhcnREYXRlRWwiLCJnZXRFbGVtZW50QnlEYXRlIiwicG9zaXRpb24iLCJzaG93IiwidG9wIiwibGVmdCIsIiRlbmREYXRlRWwiLCJpbmRleCIsImRyYXdNYXJrZXJPbkhvdmVyIiwidGFyZ2V0VW5pdCIsImhvdmVyRGF0ZSIsImlzU2FtZU9yQmVmb3JlIiwiZGF0ZSIsImVsZW1lbnQiLCJwYXJlbnQiLCJwYXJzZUludCIsImlzTmFOIiwiZWwiLCJqUXVlcnkiLCJUaGVBd2VCb29raW5nIiwibW9tbWVudCIsIndpbmRvdyJdLCJtYXBwaW5ncyI6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TUFoS0gsRUFnS1dDLGNBQWNDLE9BQWQsSUFBeUJDLE9BQU81RSxNQWhLM0MsRSIsImZpbGUiOiJcXGpzXFxhZG1pblxcc2NoZWR1bGUtY2FsZW5kYXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIoZnVuY3Rpb24oJCwgbW9tZW50KSB7XHJcbiAgJ3VzZSBzdHJpY3QnO1xyXG5cclxuICBjb25zdCBEQVRFX0ZPUk1BVCA9ICdZWVlZLU1NLUREJztcclxuXHJcbiAgY29uc3QgU2VsZWN0aW9uID0gQmFja2JvbmUuTW9kZWwuZXh0ZW5kKHtcclxuICAgIGRlZmF1bHRzOiB7XHJcbiAgICAgIHVuaXQ6IG51bGwsXHJcbiAgICAgIGVuZERhdGU6IG51bGwsXHJcbiAgICAgIHN0YXJ0RGF0ZTogbnVsbCxcclxuICAgIH0sXHJcblxyXG4gICAgdmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpIHtcclxuICAgICAgLy8gLi4uXHJcbiAgICB9LFxyXG5cclxuICAgIGNsZWFyU2VsZWN0ZWREYXRlKG5ld1VuaXQpIHtcclxuICAgICAgdGhpcy5zZXQoeyBzdGFydERhdGU6IG51bGwsIGVuZERhdGU6IG51bGwgfSk7XHJcbiAgICAgIHRoaXMuc2V0KCd1bml0JywgbmV3VW5pdCk7XHJcbiAgICB9LFxyXG5cclxuICAgIGdldE5pZ2h0cygpIHtcclxuICAgICAgaWYgKCEgdGhpcy5oYXMoJ2VuZERhdGUnKSB8fCAhIHRoaXMuaGFzKCdzdGFydERhdGUnKSkge1xyXG4gICAgICAgIHJldHVybiAwO1xyXG4gICAgICB9XHJcblxyXG4gICAgICByZXR1cm4gdGhpcy5nZXQoJ2VuZERhdGUnKS5kaWZmKHRoaXMuZ2V0KCdzdGFydERhdGUnKSwgJ2RheXMnKTtcclxuICAgIH1cclxuICB9KTtcclxuXHJcbiAgY29uc3QgU2NoZWR1bGVDYWxlbmRhciA9IEJhY2tib25lLlZpZXcuZXh0ZW5kKHtcclxuICAgIG9wdGlvbnM6IHtcclxuICAgICAgZGVidWc6IHRydWUsXHJcbiAgICAgIG1hcmtlcjogJy5hd2Vib29raW5nLXNjaGVkdWxlX19tYXJrZXInLFxyXG4gICAgfSxcclxuXHJcbiAgICBldmVudHM6IHtcclxuICAgICAgJ2NsaWNrIC5hd2Vib29raW5nLXNjaGVkdWxlX19kYXknOiAnc2V0U2VsZWN0aW9uRGF0ZScsXHJcbiAgICAgICdtb3VzZWVudGVyIC5hd2Vib29raW5nLXNjaGVkdWxlX19kYXknOiAnZHJhd01hcmtlck9uSG92ZXInLFxyXG4gICAgfSxcclxuXHJcbiAgICBpbml0aWFsaXplKCkge1xyXG4gICAgICB0aGlzLm1vZGVsID0gbmV3IFNlbGVjdGlvbjtcclxuXHJcbiAgICAgIHRoaXMuJG1hcmtlciA9IHRoaXMuJGVsLmZpbmQodGhpcy5vcHRpb25zLm1hcmtlcik7XHJcbiAgICAgIHRoaXMuJG1hcmtlci5oaWRlKCk7XHJcblxyXG4gICAgICAkKGRvY3VtZW50KS5vbigna2V5dXAnLCB0aGlzLmtleXVwLmJpbmQodGhpcykpO1xyXG4gICAgICAvLyAkKGRvY3VtZW50KS5vZmYoJ2tleXVwJywgdGhpcy5rZXl1cCk7XHJcblxyXG4gICAgICB0aGlzLmxpc3RlblRvKHRoaXMubW9kZWwsICdjaGFuZ2U6c3RhcnREYXRlIGNoYW5nZTplbmREYXRlJywgdGhpcy5zZXRNYXJrZXJQb3NpdGlvbik7XHJcbiAgICAgIGlmICh0aGlzLm9wdGlvbnMuZGVidWcpIHtcclxuICAgICAgICB0aGlzLmxpc3RlblRvKHRoaXMubW9kZWwsICdjaGFuZ2UnLCB0aGlzLmRlYnVnKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgdGhpcy4kZWwuZGF0YSgnc2NoZWR1bGUtY2FsZW5kYXInLCB0aGlzKTtcclxuICAgIH0sXHJcblxyXG4gICAgZGVidWcgKCkge1xyXG4gICAgICBpZiAodGhpcy5tb2RlbC5oYXMoJ3N0YXJ0RGF0ZScpICYmIHRoaXMubW9kZWwuaGFzKCdlbmREYXRlJykpIHtcclxuICAgICAgICBjb25zb2xlLmxvZyh0aGlzLm1vZGVsLmdldCgndW5pdCcpLCB0aGlzLm1vZGVsLmdldCgnc3RhcnREYXRlJykuZm9ybWF0KERBVEVfRk9STUFUKSArICcgLSAnICsgdGhpcy5tb2RlbC5nZXQoJ2VuZERhdGUnKS5mb3JtYXQoREFURV9GT1JNQVQpKTtcclxuICAgICAgfSBlbHNlIGlmICh0aGlzLm1vZGVsLmhhcygnc3RhcnREYXRlJykpIHtcclxuICAgICAgICBjb25zb2xlLmxvZyh0aGlzLm1vZGVsLmdldCgndW5pdCcpLCB0aGlzLm1vZGVsLmdldCgnc3RhcnREYXRlJykuZm9ybWF0KERBVEVfRk9STUFUKSArICcgLSBudWxsJyk7XHJcbiAgICAgIH0gZWxzZSBpZih0aGlzLm1vZGVsLmhhcygnZW5kRGF0ZScpKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2codGhpcy5tb2RlbC5nZXQoJ3VuaXQnKSwgJ251bGwnICsgJyAtICcgKyB0aGlzLm1vZGVsLmdldCgnZW5kRGF0ZScpLmZvcm1hdChEQVRFX0ZPUk1BVCkpO1xyXG4gICAgICB9XHJcbiAgICB9LFxyXG5cclxuICAgIGtleXVwKGUpIHtcclxuICAgICAgaWYgKGUua2V5Q29kZSA9PSAyNykge1xyXG4gICAgICAgIHRoaXMubW9kZWwuY2xlYXJTZWxlY3RlZERhdGUoKTtcclxuICAgICAgfVxyXG4gICAgfSxcclxuXHJcbiAgICBzZXRTZWxlY3Rpb25EYXRlKGUpIHtcclxuICAgICAgY29uc3QgJHRhcmdldCA9ICQoZS5jdXJyZW50VGFyZ2V0KTtcclxuICAgICAgY29uc3Qgc2V0VW5pdCA9IHRoaXMuZ2V0VW5pdEJ5RWxlbWVudCgkdGFyZ2V0KTtcclxuICAgICAgY29uc3QgY2xpY2tEYXRlID0gbW9tZW50KCR0YXJnZXQuZGF0YSgnZGF0ZScpKTtcclxuXHJcbiAgICAgIGlmICh0aGlzLm1vZGVsLmhhcygndW5pdCcpICYmIHNldFVuaXQgIT09IHRoaXMubW9kZWwuZ2V0KCd1bml0JylcclxuICAgICAgICAgIHx8IHRoaXMubW9kZWwuaGFzKCdzdGFydERhdGUnKSAmJiB0aGlzLm1vZGVsLmhhcygnZW5kRGF0ZScpXHJcbiAgICAgICAgICB8fCB0aGlzLm1vZGVsLmhhcygnc3RhcnREYXRlJykgJiYgY2xpY2tEYXRlLmlzQmVmb3JlKHRoaXMubW9kZWwuZ2V0KCdzdGFydERhdGUnKSwgJ2RheScpKSB7XHJcbiAgICAgICAgdGhpcy5tb2RlbC5jbGVhclNlbGVjdGVkRGF0ZShzZXRVbml0KTtcclxuICAgICAgfVxyXG5cclxuICAgICAgaWYgKCF0aGlzLm1vZGVsLmhhcygnc3RhcnREYXRlJykgJiYgIXRoaXMubW9kZWwuaGFzKCdlbmREYXRlJykpIHtcclxuICAgICAgICB0aGlzLm1vZGVsLnNldCgndW5pdCcsIHNldFVuaXQpO1xyXG4gICAgICAgIHRoaXMubW9kZWwuc2V0KCdzdGFydERhdGUnLCBjbGlja0RhdGUuY2xvbmUoKSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGhpcy5tb2RlbC5zZXQoJ2VuZERhdGUnLCBjbGlja0RhdGUuY2xvbmUoKSk7XHJcbiAgICAgICAgdGhpcy50cmlnZ2VyKCdhcHBseScsIHRoaXMubW9kZWwsIHRoaXMpO1xyXG4gICAgICAgIGNvbnNvbGUubG9nKHRoaXMubW9kZWwuZ2V0TmlnaHRzKCkpO1xyXG4gICAgICB9XHJcbiAgICB9LFxyXG5cclxuICAgIHNldE1hcmtlclBvc2l0aW9uKCkge1xyXG4gICAgICBjb25zdCBlbmREYXRlID0gdGhpcy5tb2RlbC5nZXQoJ2VuZERhdGUnKTtcclxuICAgICAgY29uc3Qgc3RhcnREYXRlID0gdGhpcy5tb2RlbC5nZXQoJ3N0YXJ0RGF0ZScpO1xyXG5cclxuICAgICAgaWYgKF8uaXNOdWxsKHN0YXJ0RGF0ZSkgJiYgXy5pc051bGwoZW5kRGF0ZSkpIHtcclxuICAgICAgICB0aGlzLiRtYXJrZXIuY3NzKCd3aWR0aCcsIDYwKS5oaWRlKCk7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBjb25zdCAkc3RhcnREYXRlRWwgPSB0aGlzLmdldEVsZW1lbnRCeURhdGUodGhpcy5tb2RlbC5nZXQoJ3VuaXQnKSwgc3RhcnREYXRlKTtcclxuICAgICAgaWYgKF8uaXNOdWxsKGVuZERhdGUpKSB7XHJcbiAgICAgICAgY29uc3QgcG9zaXRpb24gPSAkc3RhcnREYXRlRWwucG9zaXRpb24oKTtcclxuICAgICAgICB0aGlzLiRtYXJrZXIuc2hvdygpLmNzcyh7IHRvcDogcG9zaXRpb24udG9wLCBsZWZ0OiBwb3NpdGlvbi5sZWZ0IH0pO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGNvbnN0ICRlbmREYXRlRWwgPSB0aGlzLmdldEVsZW1lbnRCeURhdGUodGhpcy5tb2RlbC5nZXQoJ3VuaXQnKSwgZW5kRGF0ZSk7XHJcbiAgICAgICAgdGhpcy4kbWFya2VyLmNzcygnd2lkdGgnLCAoJGVuZERhdGVFbC5pbmRleCgpIC0gJHN0YXJ0RGF0ZUVsLmluZGV4KCkgKyAxKSAqIDYwKTtcclxuICAgICAgfVxyXG4gICAgfSxcclxuXHJcbiAgICBkcmF3TWFya2VyT25Ib3ZlcihlKSB7XHJcbiAgICAgIGNvbnN0ICR0YXJnZXQgPSAkKGUuY3VycmVudFRhcmdldCk7XHJcbiAgICAgIGNvbnN0IHRhcmdldFVuaXQgPSB0aGlzLmdldFVuaXRCeUVsZW1lbnQoJHRhcmdldCk7XHJcblxyXG4gICAgICBpZiAoIXRoaXMubW9kZWwuaGFzKCd1bml0JylcclxuICAgICAgICB8fCB0aGlzLm1vZGVsLmdldCgndW5pdCcpICE9PSB0YXJnZXRVbml0XHJcbiAgICAgICAgfHwgIXRoaXMubW9kZWwuaGFzKCdzdGFydERhdGUnKVxyXG4gICAgICAgIHx8IHRoaXMubW9kZWwuaGFzKCdzdGFydERhdGUnKSAmJiB0aGlzLm1vZGVsLmhhcygnZW5kRGF0ZScpKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBjb25zdCBob3ZlckRhdGUgPSBtb21lbnQoJHRhcmdldC5kYXRhKCdkYXRlJykpO1xyXG4gICAgICBjb25zdCBzdGFydERhdGUgPSB0aGlzLm1vZGVsLmdldCgnc3RhcnREYXRlJyk7XHJcblxyXG4gICAgICBpZiAoc3RhcnREYXRlLmlzU2FtZU9yQmVmb3JlKGhvdmVyRGF0ZSwgJ2RheScpKSB7XHJcbiAgICAgICAgY29uc3QgJHN0YXJ0RGF0ZUVsID0gdGhpcy5nZXRFbGVtZW50QnlEYXRlKHRhcmdldFVuaXQsIHN0YXJ0RGF0ZSk7XHJcbiAgICAgICAgdGhpcy4kbWFya2VyLmNzcygnd2lkdGgnLCAoJHRhcmdldC5pbmRleCgpIC0gJHN0YXJ0RGF0ZUVsLmluZGV4KCkgKyAxKSAqIDYwKTtcclxuICAgICAgfVxyXG4gICAgfSxcclxuXHJcbiAgICBnZXRFbGVtZW50QnlEYXRlKHVuaXQsIGRhdGUpIHtcclxuICAgICAgaWYgKHR5cGVvZiBkYXRlID09PSAnb2JqZWN0Jykge1xyXG4gICAgICAgIGRhdGUgPSBkYXRlLmZvcm1hdChEQVRFX0ZPUk1BVCk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHJldHVybiB0aGlzLiRlbFxyXG4gICAgICAgIC5maW5kKCdbZGF0YS11bml0PVwiJyArIHVuaXQgKyAnXCJdJylcclxuICAgICAgICAuZmluZCgnLmF3ZWJvb2tpbmctc2NoZWR1bGVfX2RheVtkYXRhLWRhdGU9XCInICsgZGF0ZSArICdcIl0nKTtcclxuICAgIH0sXHJcblxyXG4gICAgZ2V0VW5pdEJ5RWxlbWVudChlbGVtZW50KSB7XHJcbiAgICAgIGxldCB1bml0ID0gJChlbGVtZW50KS5kYXRhKCd1bml0Jyk7XHJcblxyXG4gICAgICBpZiAodHlwZW9mIHVuaXQgPT09ICd1bmRlZmluZWQnKSB7XHJcbiAgICAgICAgdW5pdCA9ICQoZWxlbWVudCkucGFyZW50KCkuZGF0YSgndW5pdCcpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICB1bml0ID0gcGFyc2VJbnQodW5pdCwgMTApO1xyXG4gICAgICByZXR1cm4gISBpc05hTih1bml0KSA/IHVuaXQgOiAwO1xyXG4gICAgfSxcclxuICB9KTtcclxuXHJcbiAgbmV3IFNjaGVkdWxlQ2FsZW5kYXIoe1xyXG4gICAgZWw6ICcuYXdlYm9va2luZy1zY2hlZHVsZSdcclxuICB9KTtcclxuXHJcbn0pKGpRdWVyeSwgVGhlQXdlQm9va2luZy5tb21tZW50IHx8IHdpbmRvdy5tb21lbnQpO1xyXG5cblxuXG4vLyBXRUJQQUNLIEZPT1RFUiAvL1xuLy8gLi9hc3NldHMvanNzcmMvYWRtaW4vY2FsZW5kYXIvc2NoZWR1bGUtY2FsZW5kYXIuanMiXSwic291cmNlUm9vdCI6IiJ9